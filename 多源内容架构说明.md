# 多源内容架构设计

## 设计理念

Maze Lab 的内容库设计支持**多平台内容源**，当前已支持小红书（XHS），未来可轻松扩展至微博、抖音、知乎等平台。

## 数据库 Schema 设计

### 字段分类

数据库采用**双层字段设计**：

1. **通用字段**：适用于所有内容来源
2. **平台特定字段**：保留平台独有的元数据

这样的设计确保：
- ✅ 跨平台内容可以统一查询和推荐
- ✅ 保留平台特有信息，便于平台特定功能
- ✅ 不丢失任何原始数据

### 完整字段列表（42个字段）

```sql
CREATE TABLE articles (
    -- ==================== 核心字段（所有来源通用） ====================
    id TEXT PRIMARY KEY,              -- 唯一标识
    source TEXT DEFAULT 'manual',     -- 内容来源：xhs, manual, weibo, douyin 等
    source_item_id TEXT,              -- 来源平台的内容ID
    original_url TEXT,                -- 原始链接

    -- ==================== 内容字段（通用） ====================
    title TEXT,                       -- 标题
    content TEXT,                     -- 完整内容（Markdown格式，包含图片）
    content_plain TEXT,               -- 纯文本内容（无格式）
    summary TEXT,                     -- 摘要

    -- ==================== 作者信息（通用 + 平台特定） ====================
    author TEXT,                      -- 作者信息（JSON对象）
    user_id TEXT,                     -- 【小红书】用户ID
    user_nickname TEXT,               -- 【小红书】用户昵称
    user_avatar TEXT,                 -- 【小红书】用户头像URL

    -- ==================== 媒体资源（通用） ====================
    media TEXT,                       -- 媒体列表（JSON数组）
    imageUrl TEXT,                    -- 主图URL
    cover TEXT,                       -- 封面图URL
    cover_url TEXT,                   -- 封面图URL（兼容字段）
    images TEXT,                      -- 【小红书】图片数组（JSON格式）
    video_url TEXT,                   -- 视频URL

    -- ==================== 平台特定字段 ====================
    xsec_token TEXT,                  -- 【小红书】安全令牌
    note_type TEXT,                   -- 【小红书】笔记类型
    desc TEXT,                        -- 【小红书】笔记描述
    type TEXT,                        -- 【小红书】笔记类型（normal/video）

    -- ==================== 统计数据 ====================
    liked_count TEXT,                 -- 点赞数
    collected_count TEXT,             -- 收藏数
    comment_count TEXT,               -- 评论数
    share_count TEXT,                 -- 分享数

    -- ==================== 分类和标签（通用） ====================
    category TEXT,                    -- 分类
    tags TEXT,                        -- 标签列表（JSON数组）
    topics TEXT,                      -- 话题列表（JSON数组）
    tag_list TEXT,                    -- 【小红书】标签列表（JSON数组）

    -- ==================== 其他元数据 ====================
    tone TEXT DEFAULT 'Casual',       -- 内容风格
    estimatedReadTime INTEGER,        -- 预估阅读时长（秒）
    language TEXT DEFAULT 'zh',       -- 语言

    -- ==================== 时间字段 ====================
    time INTEGER,                     -- 【小红书】发布时间（Unix时间戳，秒）
    publish_time INTEGER,             -- 通用发布时间（Unix时间戳，毫秒）
    created_at INTEGER,               -- 创建/入库时间
    updated_at INTEGER,               -- 更新时间

    -- ==================== 库管理字段 ====================
    library_type TEXT DEFAULT 'personal',  -- 库类型：personal, community
    owner_id TEXT,                    -- 所有者/贡献者ID
    isPublic INTEGER DEFAULT 1,       -- 是否公开
    status TEXT DEFAULT 'active',     -- 状态：active, archived, deleted
    deletedAt INTEGER                 -- 软删除时间戳
)
```

## 数据流设计

### 小红书内容入库流程

```
小红书 API
    ↓
XHSNoteDetail（爬虫返回）
    ↓
convertXHSNoteToArticle（转换函数）
    ├─→ 填充通用字段（source, title, content, author, media...）
    └─→ 填充小红书特定字段（xsec_token, desc, user_id...）
    ↓
Article 对象（42个字段）
    ↓
db.saveArticle()
    ↓
POST /api/articles
    ↓
INSERT OR REPLACE（42个字段）
    ↓
SQLite 数据库
```

### 其他平台扩展示例（未来）

**微博内容入库**：
```javascript
function convertWeiboToArticle(weibo, userId) {
  return {
    // 通用字段
    id: `weibo-${weibo.id}-${Date.now()}`,
    source: 'weibo',
    source_item_id: weibo.id,
    title: weibo.text.slice(0, 50),
    content: weibo.text,
    content_plain: weibo.text,
    author: {
      id: weibo.user.id,
      name: weibo.user.screen_name,
      avatar: weibo.user.avatar_hd
    },

    // 微博特定字段（可以复用或添加新字段）
    liked_count: String(weibo.attitudes_count),
    comment_count: String(weibo.comments_count),
    share_count: String(weibo.reposts_count),

    // ... 其他字段
  };
}
```

## 查询设计

### 跨平台通用查询

```sql
-- 查询所有内容（不区分来源）
SELECT id, title, content, author, publish_time
FROM articles
WHERE status = 'active';

-- 按作者查询（通用）
SELECT * FROM articles
WHERE json_extract(author, '$.id') = 'user123';
```

### 平台特定查询

```sql
-- 查询小红书内容
SELECT id, title, desc, user_nickname, xsec_token
FROM articles
WHERE source = 'xhs';

-- 查询小红书特定用户
SELECT * FROM articles
WHERE source = 'xhs' AND user_id = '660590a4000000000600c300';
```

## 推荐系统兼容性

### 统一接口

推荐系统使用**通用字段**进行推荐：

```typescript
interface RecommendationItem {
  id: string;
  title: string;
  summary: string;
  category: string;
  tags: string[];
  // 来源无关
}
```

### 平台特定展示

前端根据 `source` 字段决定展示方式：

```typescript
if (article.source === 'xhs') {
  // 显示小红书特有的标签样式、用户昵称等
  renderXHSCard(article);
} else if (article.source === 'weibo') {
  // 显示微博特有的转发数等
  renderWeiboCard(article);
} else {
  // 通用展示
  renderGenericCard(article);
}
```

## 优势总结

### ✅ 扩展性强
- 新增平台只需添加对应的转换函数
- 数据库 schema 无需修改（已包含足够的通用字段）
- 平台特定字段可以复用现有字段

### ✅ 数据完整
- 保留所有平台的原始数据
- 通用字段确保跨平台一致性
- 平台字段保留独特信息

### ✅ 查询灵活
- 可以跨平台统一查询
- 可以针对特定平台查询
- 支持混合查询

### ✅ 兼容性好
- 新旧代码可以共存
- 逐步迁移，无需一次性重构
- 前端可以根据需要选择展示方式

## 未来扩展方向

1. **添加更多平台**
   - 微博、抖音、知乎、Bilibili
   - 每个平台一个转换函数

2. **平台特定功能**
   - 小红书：笔记收藏、专辑
   - 微博：转发、评论树
   - 抖音：挑战、音乐

3. **统一元数据**
   - 情感分析（所有平台通用）
   - 热度计算（统一算法）
   - 标签归一化（跨平台标签映射）

## 代码位置

- **Schema 定义**：`server/database.js`（第40-102行）
- **转换函数**：`services/autoCrawlService.ts`（convertXHSNoteToArticle）
- **保存逻辑**：`server/index.js`（POST /api/articles）
- **查询接口**：`server/index.js`（GET /api/articles）
