# 字段映射修复说明

## 问题分析

### 小红书搜索返回的数据结构（XHSNote）
```typescript
{
  id: string;
  xsec_token: string;      // ⚠️ 搜索返回，但转换时丢失
  title: string;
  desc: string;
  type: string;            // ⚠️ 搜索返回，但转换时丢失
  user: {
    user_id: string;
    nickname: string;
    avatar: string;
  };
  cover: string;           // ⚠️ 搜索返回，但转换时丢失
  liked_count: string;
}
```

### 小红书详情返回的数据结构（XHSNoteDetail）
```typescript
{
  id: string;
  title: string;
  desc: string;
  type: string;            // ✅ 详情中有
  user: { user_id, nickname, avatar };
  images: string[];
  video_url: string;       // ✅ 详情中有
  liked_count: string;
  collected_count: string;
  comment_count: string;
  share_count: string;     // ⚠️ 转换时被硬编码为0
  time: number;
  tag_list: string[];
}
```

## 修复内容

### 1. 更新 convertXHSNoteToArticle 函数

**修复前的问题：**
- ❌ 缺少 `xsec_token`（搜索返回，但转换时丢失）
- ❌ 缺少 `note_type`（type 字段未映射）
- ❌ 缺少 `video_url`（详情中有，但未保存）
- ❌ 缺少 `cover_url`（搜索返回的 cover 未保存）
- ❌ `share_count` 被硬编码为 0（应该使用实际值）

**修复后：**
- ✅ 添加 `xsec_token` 参数，从搜索结果传递
- ✅ 添加 `cover_url` 参数，从搜索结果传递
- ✅ 映射 `note.type` → `note_type`
- ✅ 映射 `note.video_url` → `video_url`
- ✅ 使用实际的 `share_count` 值

### 2. 更新调用逻辑

在 `crawlAndImportByKeywords` 函数中：
- 传递 `note.xsec_token` 给转换函数
- 传递 `note.cover` 给转换函数

### 3. 数据库表结构

已确保包含所有字段：
- `xsec_token` TEXT
- `note_type` TEXT
- `video_url` TEXT
- `cover_url` TEXT
- `author` TEXT (JSON)
- `content_plain` TEXT

### 4. 后端保存逻辑

已更新 INSERT 语句，包含所有29个字段：
- 基础字段（id, source, source_item_id, original_url）
- 内容字段（title, summary, content, content_plain）
- 作者字段（author）
- 媒体字段（media, imageUrl, xsec_token, note_type, video_url, cover_url）
- 分类字段（category, tags, topics）
- 元数据字段（tone, estimatedReadTime, language）
- 统计字段（metrics）
- 时间字段（created_at, publish_time）
- 上下文字段（crawl_context）
- 状态字段（status, isPublic, ownerId, deletedAt）

## 字段映射表

| 小红书字段 | Article字段 | 来源 | 说明 |
|-----------|------------|------|------|
| `id` | `source_item_id` | 搜索/详情 | 笔记ID |
| `xsec_token` | `xsec_token` | 搜索 | 安全令牌 |
| `title` | `title` | 搜索/详情 | 标题 |
| `desc` | `content_plain`, `summary` | 搜索/详情 | 描述 |
| `type` | `note_type` | 搜索/详情 | 笔记类型 |
| `user` | `author` | 搜索/详情 | 用户信息转换 |
| `cover` | `cover_url` | 搜索 | 封面图 |
| `images[]` | `media[]` | 详情 | 图片列表 |
| `video_url` | `video_url` | 详情 | 视频URL |
| `liked_count` | `metrics.likes` | 搜索/详情 | 点赞数 |
| `collected_count` | `metrics.favorites` | 详情 | 收藏数 |
| `comment_count` | `metrics.comments` | 详情 | 评论数 |
| `share_count` | `metrics.shares` | 详情 | 分享数（修复：使用实际值） |
| `time` | `publish_time` | 详情 | 发布时间（秒转毫秒） |
| `tag_list[]` | `tags[]` | 详情 | 标签列表 |

## 验证步骤

1. 重启后端服务，确保数据库表结构正确
2. 运行关键词搜索导入功能
3. 检查保存的文章是否包含所有字段：
   - `xsec_token` 不为空
   - `note_type` 不为空
   - `video_url` 不为空（如果有视频）
   - `cover_url` 不为空
   - `metrics.shares` 使用实际值

## 注意事项

- 如果字段不存在，保存为 `null`（不会报错）
- 数据库会自动检查并添加缺失字段
- 所有字段都是可选的，兼容其他来源的内容

