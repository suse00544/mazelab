# 小红书评论获取功能问题记录

## 问题描述

获取评论的功能一直失败，表现为：
- 搜索、获取笔记详情等功能正常
- 但获取评论时返回 HTTP 461 错误（需要登录/Cookie无效）

## 已完成的修复

### 1. xsec_token 传递问题修复 ✅
**问题**: 获取评论时 `xsec_token` 没有被正确传递
**修复**:
- 在 `XHSNoteDetail` 接口中添加 `xsec_token` 字段
- `handleXhsGetDetail` 保存 `xsec_token` 到状态
- `handleXhsGetComments` 使用保存的 `xsec_token`

**文件修改**:
- `services/xhsService.ts` - 添加 `xsec_token?: string`
- `pages/Admin.tsx` - 保存和使用 `xsec_token`

### 2. Cookie 缓存功能 ✅
**实现功能**:
- Cookie 自动保存到 `cache/xhs_session.json`，有效期 7 天
- 爬虫重启时自动加载缓存的 Cookie
- 新增 `/cookie-status` 和 `/clear-cookies` 端点
- Cookie 失效时返回 401 状态码和 `COOKIE_EXPIRED` 错误
- 前端检测到 Cookie 失效时自动弹出设置窗口

**文件修改**:
- `crawler/xhs/cache.py` - 已存在的缓存模块
- `crawler/xhs/client.py` - 添加 `CookieExpiredError` 异常类
- `crawler/main.py` - 集成缓存加载和保存
- `server/index.js` - 添加代理路由
- `services/xhsService.ts` - 添加新 API 和错误类
- `pages/Admin.tsx` - 处理 Cookie 失效错误

## 当前状态

### 现象
```
[Client] GET https://edith.xiaohongshu.com/api/sns/web/v2/comment/page -> 461
[Client] GET https://edith.xiaohongshu.com/api/sns/web/v2/comment/page -> 461
[Client] GET https://edith.xiaohongshu.com/api/sns/web/v2/comment/page -> 461
INFO:     127.0.0.1:61615 - "POST /comments HTTP/1.1" 500 Internal Server Error
```

### 分析
1. **其他 API 正常工作**:
   - POST `/api/sns/web/v1/search/notes` → 200 OK
   - POST `/api/sns/web/v1/feed` (笔记详情) → 200 OK

2. **评论 API 特殊性**:
   - 使用 v2 API: `/api/sns/web/v2/comment/page`
   - 使用 GET 方法（而非 POST）
   - 对认证要求更严格

3. **可能的原因**:
   - 评论 API 需要更完整的登录态（不仅是基本 Cookie）
   - 需要特定的 Cookie 字段（如完整的 `web_session`）
   - 可能有额外的签名或验证机制
   - Cookie 的有效性在不同 API 之间可能不同

## 待尝试的解决方案

### 方案 1: 验证 Cookie 完整性
- [ ] 确认用户提供的 Cookie 包含所有必需字段
- [ ] 特别检查 `web_session`、`a1`、`webId` 等关键字段
- [ ] 对比能正常工作的搜索 API 和失败的评论 API 使用的 Cookie

### 方案 2: 检查签名和请求头
- [ ] 检查评论 API 的签名生成是否正确
- [ ] 对比评论 API 和其他 API 的请求头差异
- [ ] 确认 `X-S`、`X-T` 等签名字段是否正确

### 方案 3: 调整获取方式
- [ ] 尝试使用不同的 `xsec_source` 参数
- [ ] 研究是否需要先访问笔记详情页才能获取评论
- [ ] 检查是否需要额外的权限或状态

### 方案 4: 使用浏览器自动化
- [ ] 考虑使用 Playwright 直接在浏览器中获取评论
- [ ] 利用浏览器的真实登录态和 Cookie
- [ ] 通过页面交互获取评论数据

## 技术细节

### 请求对比

**成功的笔记详情请求**:
```
POST https://edith.xiaohongshu.com/api/sns/web/v1/feed
Status: 200 OK
```

**失败的评论请求**:
```
GET https://edith.xiaohongshu.com/api/sns/web/v2/comment/page
Status: 461 (需要登录)
```

### 关键代码位置

**客户端评论获取** (`crawler/xhs/client.py:221-267`):
```python
async def get_note_comments(
    self,
    note_id: str,
    xsec_token: str = "",
    cursor: str = "",
    num: int = 10,
    get_sub_comments: bool = True,
) -> Dict:
    uri = "/api/sns/web/v2/comment/page"
    params = {
        "note_id": note_id,
        "cursor": cursor,
        "top_comment_id": "",
        "image_formats": "jpg,webp,avif",
        "xsec_token": xsec_token,
        "num": num,
    }
    result = await self.get(uri, params)
    # ...
```

**后端代理** (`server/index.js:920-947`):
```javascript
app.post('/api/xhs/comments', async (req, res) => {
    // 处理 Cookie 失效错误 (401)
    if (response.status === 401) {
        // ...
    }
});
```

## 下一步行动

1. **收集更多信息**:
   - 在浏览器开发者工具中手动访问评论 API
   - 对比成功的手动请求和程序请求的差异
   - 检查是否有隐藏的验证机制

2. **验证 Cookie**:
   - 确保用户提供的是登录后的完整 Cookie
   - 测试 Cookie 在浏览器中的有效性
   - 尝试使用刚登录后立即复制的 Cookie

3. **考虑替代方案**:
   - 如果 API 方式持续失败，考虑使用 Playwright 页面抓取
   - 研究是否需要模拟完整的用户行为流程

## 参考资料

- 小红书爬虫项目: https://github.com/suse00544/MediaCrawler
- HTTP 461 错误: 表示需要登录或 Cookie 无效
- 评论 API 端点: `/api/sns/web/v2/comment/page`

## 更新日志

- 2024-12-17: 创建文档，记录问题和已完成的修复
- 待续...
