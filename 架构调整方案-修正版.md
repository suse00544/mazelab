# 架构调整方案 - 修正版

## 一、核心概念

### 两个独立的内容库

#### 1. 个人库（Personal Library）
- **定义**：每个用户独立维护的私人内容库
- **标识**：`library_type='personal'`, `owner_id=userId`
- **来源**：
  - ✅ 用户手动添加
  - ❌ 实验中不会自动添加（待确认）
- **用途**：用户可以选择从个人库推荐内容
- **特点**：完全个性化，用户完全控制

#### 2. 社区库（Community Library）
- **定义**：所有用户共享的公共内容库
- **标识**：`library_type='community'`, `owner_id=贡献者userId`
- **来源**：
  - ❌ 不能手动添加
  - ✅ 所有用户在所有实验中检索的内容自动进入
- **用途**：用户可以选择从社区库推荐内容
- **特点**：众包内容，随使用自然增长，可追溯贡献者

## 二、数据模型

### 数据库字段（已完成）
```sql
articles:
  - library_type: 'personal' | 'community'
  - owner_id: 用户ID（标识所有者或贡献者）

experiments:
  - mode: 'solo' | 'community' （改名为 content_source）
```

### 文章来源追溯
- `owner_id` 字段记录：
  - 个人库：内容所有者
  - 社区库：内容贡献者（哪个用户的实验检索到的）

## 三、用户界面

### 1. 内容管理界面（Admin）

```
┌─────────────────────────────────────┐
│  [我的个人库] [社区库]              │
├─────────────────────────────────────┤
│                                     │
│  Tab 1: 我的个人库                  │
│  - 显示：owner_id=当前用户 的内容   │
│  - 操作：✅ 手动添加  ✅ 删除       │
│  - 来源：用户主动添加               │
│                                     │
│  Tab 2: 社区库                      │
│  - 显示：所有 library_type=community│
│  - 操作：❌ 不能添加  ✅ 查看详情   │
│  - 来源：显示贡献者（owner_id）     │
│  - 筛选：可按贡献者过滤             │
│                                     │
└─────────────────────────────────────┘
```

### 2. 实验创建流程（统一）

```
┌─────────────────────────────────────┐
│  创建新实验                          │
├─────────────────────────────────────┤
│                                     │
│  1. 实验名称                        │
│     [输入框]                        │
│                                     │
│  2. 内容来源                        │
│     ○ 个人库 (N 条内容)            │
│     ○ 社区库 (M 条内容)            │
│                                     │
│     💡 提示：个人库为空时          │
│        "个人库暂无内容，请先添加"   │
│                                     │
│  3. Strategy Prompt                │
│     [文本框 - 多行]                │
│                                     │
│  4. Content Prompt                 │
│     [文本框 - 多行]                │
│                                     │
│  [取消]  [创建实验]                │
│                                     │
└─────────────────────────────────────┘
```

### 3. 实验运行逻辑

```
用户开始实验
    ↓
根据实验配置，从选定的库（个人/社区）检索内容
    ↓
生成推荐列表
    ↓
用户查看、交互
    ↓
需要更多内容？
    ↓
调用小红书 API 检索新内容
    ↓
保存新内容到社区库
    library_type = 'community'
    owner_id = 当前用户ID（记录贡献者）
    ↓
继续推荐...
```

## 四、API 设计

### 1. 文章查询 API
```javascript
// 获取个人库
GET /api/articles?library_type=personal&owner_id=userId

// 获取社区库（所有内容）
GET /api/articles?library_type=community

// 获取社区库（按贡献者过滤）
GET /api/articles?library_type=community&contributor=userId
```

### 2. 文章保存 API
```javascript
POST /api/articles
Body: {
  ...articleData,
  library_type: 'personal' | 'community',
  owner_id: userId
}
```

### 3. 实验 API
```javascript
POST /api/experiments
Body: {
  ...experimentData,
  content_source: 'personal' | 'community'  // 改名：mode → content_source
}
```

## 五、实施步骤

### 第一步：更新数据库字段名（可选）
```sql
-- 可选：将 mode 改名为 content_source，语义更清晰
ALTER TABLE experiments RENAME COLUMN mode TO content_source;
```

### 第二步：更新后端 API
1. `GET /api/articles` - 添加来源过滤
2. `POST /api/articles` - 保存时设置 library_type 和 owner_id
3. 实验相关 API 更新

### 第三步：更新前端 UI
1. **Admin.tsx**：
   - 添加两个 Tab：个人库、社区库
   - 个人库：显示 `library_type='personal' && owner_id=userId`
   - 社区库：显示 `library_type='community'`
   - 社区库显示贡献者信息
   - 个人库可添加，社区库只读

2. **实验创建组件**：
   - 统一的创建流程
   - 内容来源选择（个人库/社区库）
   - 两个 Prompt 配置
   - 个人库为空时的提示

3. **Feed.tsx**：
   - 检索新内容时，自动保存到社区库
   - 设置 `library_type='community'`, `owner_id=userId`

## 六、用户故事

### 故事 1：使用个人库
1. Alice 创建实验，选择"个人库"
2. Alice 手动添加了 10 条她喜欢的内容到个人库
3. 实验开始，从个人库推荐内容
4. 需要更多内容时，检索小红书
5. 新检索的内容自动进入社区库（owner_id=Alice）
6. Alice 的个人库依然只有最初的 10 条
7. 社区库增加了 Alice 贡献的新内容

### 故事 2：使用社区库
1. Bob 创建实验，选择"社区库"
2. 实验开始，从社区库推荐内容（包括 Alice 贡献的）
3. 需要更多内容时，检索小红书
4. 新检索的内容自动进入社区库（owner_id=Bob）
5. Bob 可以在社区库看到自己和他人的贡献

### 故事 3：查看贡献者
1. Carol 打开"社区库"标签
2. 看到所有社区内容
3. 每条内容显示贡献者（Alice、Bob 等）
4. 可以筛选查看特定用户的贡献

## 七、关键问题确认

1. **个人库是否也接收实验中的新内容？**
   - 当前理解：否，只有社区库接收
   - 待确认

2. **实验中检索的内容保存规则**
   - 确认：总是保存到社区库
   - 待确认：是否同时保存到个人库（如果实验使用的是个人库）

3. **社区库的内容删除权限**
   - 用户是否可以删除自己贡献的社区内容？
   - 还是社区库只增不减？
